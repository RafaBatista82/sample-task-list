<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Task List</title>
    <link rel="stylesheet" href="css/styles.css">
    <script src="js/jquery-3.6.0.min.js"></script>
</head>
<body>

<div class="expandable-field">
    <div class="boton-container">
        <img src="img/plus-square.svg" alt="Type new task" class="button">
    </div>
    <div class="editor-toolbar">
        Type to add new task
    </div>
</div>
<div class="editor-container">
    <div class="editor-content">
        <div class="boton-container">
            <img src="img/plus-square.svg" alt="Type new task" class="button">
        </div>
        <div class="editor-field" contenteditable="true"></div>
        <div id="avatar" class="avatar-container disabled">
            <img src="img/Rafa-OK.jpg" alt="User Avatar" class="avatar">
        </div>
    </div>
</div>
<div class="editor-container">
    <div class="button-hotizontal-container">
    <div id="left-buttons" class="left-buttons disabled">
        <button class="list-button">
            <span class="icon"><img src="img/maximize-2.svg" alt="Open" class="button"></span>
            <span class="description">Open</span>
        </button>
        <button class="list-button">
            <span class="icon"><img src="img/calendar.svg" alt="Today" class="button"></span>
            <span class="description">Today</span>
        </button>
        <button class="list-button">
            <span class="icon"><img src="img/unlock.svg" alt="Public" class="button"></span>
            <span class="description">Public</span>
        </button>
        <button class="list-button">
            <span class="icon"><img src="img/sun.svg" alt="Normal" class="button"></span>
            <span class="description">Normal</span>
        </button>
        <button class="list-button">
            <span class="icon"><img src="img/disc.svg" alt="Estimation" class="button"></span>
            <span class="description">Estimation</span>
        </button>                        
    </div>
    
    <div class="right-buttons">
        <button id="cancel" class="list-button">
            <span class="icon"><img src="img/x.svg" alt="Cancel" class="button"></span>
            <span class="description">Cancel</span>
        </button>
        <button id="save" class="list-button">
            <span class="icon"><img src="img/save.svg" alt="Cancel" class="button"></span>
            <span class="description">OK</span>
        </button>
    </div>
</div>
</div>

    <!-- Contenedor para los datos -->
    <div class="data-container">
        <div id="results"></div>
    </div>

    <!-- Loading spinner -->
    <div class="loading">
        Cargando datos...
    </div>


<script>

$(document).ready(function() {
        let Insert = true;
        let idToEdit = 0;

        loadData();

        // Función para recargar datos
        function loadData() {
            // Mostrar loading
            $('.loading').show();
            
            $.ajax({
                url: 'includes/process.php',
                method: 'POST',
                data: { action: 'getData' },
                dataType: 'json',
                success: function(response) {
                    if (response.success) {
                        displayData(response.data);
                    } else {
                        showError(response.message);
                    }
                },
                error: function(xhr, status, error) {
                    showError('Error en la petición: ' + error);
                },
                complete: function() {
                    // Ocultar loading
                    $('.loading').hide();
                }
            });
        }  
            
            
            // Función para mostrar los datos
        function displayData(data) {
            let html = '';
            
            // Datos
            data.forEach(item => {

                Object.entries(item).forEach(([key, value]) => {  
                    if(key == 'id'){
                        html += `<div class="task-container"><div class="pointer-container" value="${value}"><img src="img/square.svg" alt="Type new task"></div>`;
                        id = value;
                    }

                    if(key == 'task'){                    
                        html += `<div class="task-value" id="task-${id}">${value}</div></div>`;
                    }    
                });

            });
            
            html += '';
            $('#results').html(html);
        }        


    // Toggle button container when clicking the edit field
    $('.editor-toolbar').on('click', function(e) {
        e.stopPropagation();
		$('.expandable-field').hide();
        $('.editor-container').show();
        //$('.editor-container').slideToggle(200);
		
    });

    $('#save').on('click', function(e) {	
        if(Insert){
                $.ajax({
					url: 'includes/process.php',
					method: 'POST',
					data: { 
						action: 'addTask',
						task: $('.editor-field').html()
					},
					dataType: 'json',
					success: function(response) {
						if (response.success) {
							// Recargar datos después de agregar
							loadData();
						}
					}
				});
        }else{
            alert("Modificacion")
        }

        $('.editor-container').hide();
        $('.expandable-field').show();		
        $('#left-buttons').addClass('disabled');	
        $('#avatar').addClass('disabled');
        $('.editor-field').empty();
        Insert = true;

    });     

    $('#cancel').on('click', function(e) {	
        e.stopPropagation();	
        //$('.editor-container').slideUp(200);
        $('.editor-container').hide();
        $('.expandable-field').show();		
        $('#left-buttons').addClass('disabled');	
        $('#avatar').addClass('disabled');
        $('.editor-field').empty();
        Insert = true;
    });    

    $('.editor-field').on('keypress', function(e) {	        
        $('#left-buttons').removeClass('disabled');	
        $('#avatar').removeClass('disabled');	 
    }); 

    $(document).on("click", "div.pointer-container", function() {
        $('.editor-field').html($('#task-' + $(this).attr("value")).html());
        $('#left-buttons').removeClass('disabled');	
        $('#avatar').removeClass('disabled');	        
		$('.expandable-field').hide();
        $('.editor-container').show();   
        Insert = false;     
    });    


    /*
    // Handle button clicks
    $('.option-button').on('click', function() {
        const selectedValue = $(this).text();
        $('.edit-field').val(selectedValue);
        $('.button-container').slideUp(200);
    });

    // Close button container when clicking outside
    $(document).on('click', function(e) {
        if (!$(e.target).closest('.expandable-field').length) {
            $('.button-container').slideUp(200);
        }
    });
 */

});

 
</script>
</body>
</html>
